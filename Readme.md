### 테라폼을 사용한 웹 애플리케이션 인프라스트럭처 프로비저닝

> - `1단계` : 먼 아마존 웹서비스 계정을 준비하고, API키를 설정
> - `2단계 STEP 1` : 인프라스트럭쳐를 정의하는 HCL 언어로 필요한 리소스를 선언
> - `2단계 STEP 2` : 선언된 리소스들이 생성가능한지 계획(Plan)을 확인
> - `2단계 STEP 3` : 선언된 리소스들을 아마존 웹 서비스에 적용(Apply)
> - `3단계` : 웹 애플리케이션 배포

### 프로비저닝 (Provisioning)

> 어떤 프로세스나 서비스를 실행하기 위한 준비 단계를 프로비저닝이라고 합니다.
> 프로비저닝에는 크게 네트워크나 컴퓨팅 자원을 준비하는 작업과 준비된 컴퓨팅 자원에 사이트 패키지나 애플리케이션 의존성을 준비하는 단계로 나누어집니다. 명확한 경계는 불분명하지만 테라폼은 전자를 주로 다루는 도구입니다.

### 프로바이더 (Provider)

> 테라폼과 외부 서비스를 연결해주는 기능을 하는 모듈입니다. 예를 들어 테라폼으로 AWS 서비스의 컴퓨팅 자원을 생성하기 위해서는 aws 프로바이더를 먼저 셋업해야 합니다. 프로바이더는 AWS, Google Cloud Platform, Microsoft Azure와 같은 범용 클라우드 서비스를 비롯해 Github, Datadog, DNSimple과 같은 특정 기능을 제공하는 서비스, MySQL, RabbitMQ, Docker와 같은 로컬 서비스 등을 지원합니다.

### 리소스 (Resource)

> 리소스란 특정 프로바이더가 제공해주는 조작 가능한 대상의 최소 단위입니다. 예를 들어 AWS 프로바이더는 aws_instance 리소스 타입을 제공하고, 이 리소스 타입을 사용해 Amazon EC2의 가상 머신 리소스를 선언하고 조작하는 것이 가능합니다. EC2 인스턴스, 시큐리티 그룹, 키 페어 모두 aws 프로바이더가 제공해주는 리소스 타입입니다.

### HCL (Hashicorp Configuration Language)

> HCL은 테라폼에서 사용하는 설정 언어입니다. 테라폼에서 모든 설정과 리로스 선언은 HCL을 사용해 이루어집니다. 테라폼에서 HCL 파일의 확장자는 `.tf`를 사용합니다.

### 계획 (Plan)

> 테라폼 프로젝트 디렉터리 아래의 모든 `.tf`파일의 내용은 실제로 적용 가능한지 확인하는 작업을 계획이라고 합니다. 테라폼은 이를 `terraform plan` 명령어로 제공하며 이 명령어를 실행하면 어떤 리로스가 생성되고 수정되고 삭제될지 계획을 보여줍니다.

### 적용 (Apply)

> 테라폼 프로젝트 디렉터리 아래의 모든 `.tf` 파일의 내용대로 리소스를 생성, 수정, 삭제하는 일을 적용이라고 합니다. 테라폼은 이를 `terraform apply`명령어로 제공합니다. 이 명령어를 실행하기 전에
> 변경 예정 사항은 plan 명령어를 사용해 확인할 수 있습니다. 적용하기 전에도 플랜의 결과를 보여줍니다.

plan의 작동 방식을 이해하기 위해서는 테라폼의 동작 방식을 이해할 필요가 있습니다. 테라폼에서 리소스는 선언적으로 기술됩니다. 테라폼은 `.tf` 파일에 기술되어있는 모든 리소스를 읽어들이고 먼저 이 리소스들이 존재하는 상태를 가정합니다. 편의상 이를 이상적인 상태라고 부르겠습니다. 예를 들어 `aws_key_pair.web_admin`은 이상적인 상태에 존재하는 리소스입니다. 하지만 이 리소스는 실제로 생성된 적은 없기 때문에 프로바이더에 지정한 AWS 계정에는 존재하지 않습니다. 즉, 내 AWS 계정의 실제 상태에는 `aws_key_pair.web_admin`이 아직 존재하지 않습니다.

테라폼의 가장 중요한 역할은 실제 상태를 이상적인 상태와 동일하게 만드는 일입니다. 테라폼에서는 이 작업을 적용한다 `apply`라고 표현합니다. 테라폼 `plan`은 `apply` 하기 전에 이상적인 상태와 실제 상태를 비교해 둘을 동일하게 만들기 위해서 해야할 일을 찾아내는 작업입니다. 이 예제에서 `aws_key_pair.web_admin` 리소스는 이상적인 상태에만 존재하고 실제 상태에는 존재하지 않습니다. 따라서 테라폼이 실제 상태를 이상적인 상태와 동일하게 만들기 위해서는 실제 상태에 `aws_key_pair.web_admin` 리소스를 생성해야 합니다.

`terraform apply`를 실행하고 나면 프로젝트 상에 중요한 변화가 하나 생기는데 작업 디렉터리 아래 `terraform.tfstate` 파일이 하나 생성됩니다. 이 파일에는 실제 상태를 임시로 저장하는 동시에 테라폼에서 관리되는 리소스의 목록을 관리합니다.

### `endpoint check (EC2)`

```bash
terraform console
aws_instance.web.public_ip
aws_instance.ec2명.public_ip
```

### `endpoint check (RDS)`

```bash
terraform console
aws_db_instance.web_db.endpoint
aws_db_instance.rds명.endpoint
```

### `ec2에서 rds 서버 접속`

```bash
sudo yum install -y mysql
mysql -h [RDS 엔드포인트] -u admin -p
```

### 임시 비밀번호 설정

코드상에 config 정보를 노출시키지 않기 위해 TLS 통신으로 가져온다고 해도 `terraform.tfstate` 파일에 노출되므로 임시 비밀번호를 설정하고 `apply`후에 비밀번호 재설정할 것.

## Why ? 테라폼을 사용하는 이유

웹 콘솔을 사용해 리소스를 관리하는 것과는 많이 다릅니다. 프로젝트에서 테라폼을 사용해보면 매번 리소스 레퍼런스를 확인하고 웹 콘솔과 비교해보는 과정을 계속해서 반복해야 합니다. 어떤 면에서는 웹 콘솔보다 오히려 어렵고 귀찮습니다.

그럼에도 불구하고 테라폼을 사용하면 좋은 점들이 있습니다. 먼저 웹 콘솔을 사용해 리소스들을 관리하면서 점차 리소스가 많아지기 시작하면 더 이상 전체 리소스를 파악할 수 없는 시점이 옵니다. 업무용으로 사용하는 경우 명시적인 리소스와 비명시적인 리소스를 포함해 수백 수천개의 리소스를 다루는 일이 일반적입니다. 언제 왜 만들었는지 알 수 없는 리소스들이 점점 쌓여나가고 레거시로 남습니다. 테라폼을 사용하면 프로비저닝하고자 하는 상태를 코드로 명확히 기록해두기 때문에 웹 콘솔만 사용할 때보다 파악이 쉬워지고 세심한 관리가 가능해집니다.

또한 테라폼은 코드로서의 인프라스트럭쳐`(Infrastructure as a Code)`를 지향하는 도구로서 코드를 작성할 때 누리던 생태계의 이점을 그대로 이용할 수 있습니다. 저장소에서 이력 추적을 할 수도 있고 깃허브(Github)에서 팀원들과 코드 리뷰를 진행할 수도 있습니다. 이 과정에서 누가 어떤 리소스를 왜 추가했는지 투명성은 자동적으로 얻어집니다. 좀 더 잘 활용한다면 CI를 사용해 코드 리뷰가 된 사항을 자동적으로 플랜 및 저굥하는 것도 가능합니다.

참고자료: [테라폼(Terraform) 기초 튜토리얼](https://www.44bits.io/ko/post/terraform_introduction_infrastrucute_as_code)
